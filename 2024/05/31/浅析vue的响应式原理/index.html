<!DOCTYPE html>
<html lang="zh-cn" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="CrazyStudent13" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  <meta name="description" content="古之立大事者，不惟有超世之才，亦必有坚忍不拔之志。" />
  
  
  
  <title>
    
      浅析vue的响应式原理 
      
      
      |
    
     远川的个人博客
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="远川的个人博客" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">远川的博客</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">主页</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">归档</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">标签</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">友链</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">关于</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">浅析vue的响应式原理</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2024-06-27 12:35:37
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/%E9%9D%A2%E8%AF%95/" title="面试">
                    #面试
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/vue3/" title="vue3">
                    #vue3
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>面试官：您能详细说说vue的双向绑定原理吗？</p>
<p>我：双向绑定是v-model的实现方式，我猜您问的不是那么简单的问题，也许您是想说vue的响应式原理？</p>
<p>面试官：对对，就是这个，您说一下Vue的双向绑定原理？</p>
<p>我：哈哈哈，我不会。</p>
<p>面试官：哈哈哈，您真幽默，和您聊得很开心，HR后续会通知您面试结果的。</p>
<span id="more"></span>



<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>因为最近找工作，面试vue3相关的知识点多一些，所以这里更多看</p>
<p>本来想考虑自己看源码写一份文档的，但是同事推荐了几篇文档之后，我觉得自己还是不要出来丢人了。</p>
<p>看了市面上几位大佬的解析之后，我觉得自己的理解多少还是菜了些。</p>
<p>这里我就转载其中一篇文档，我个人倾向于<a target="_blank" rel="noopener" href="https://juejin.cn/post/6850418111985352711#heading-0">vue响应式详解（重学前端-vue篇1） - 掘金 (juejin.cn)</a>这篇文档，因为我个人基础相对来说还可以，而且看了vue3的源码，所以这里更喜欢笼统的看个大概得思路，这样不乱。</p>
<p>不过，如果是新人，我更推荐看<a target="_blank" rel="noopener" href="https://juejin.cn/post/6932659815424458760#heading-13">0年前端的Vue响应式原理学习总结1：基本原理 - 掘金 (juejin.cn)</a>，这篇文档写的会连带着实现动机解释的很明白，如果你之前没有看过VUE的源码，那么这篇文档能让新手非常顺滑的理解vue实现的动机和过程。</p>
<p>vue的原理确实不麻烦，但是思路很精妙，我们平日大概率是用不上的，所以这里只是拓充知识。</p>
<p>毕竟，大多数人不是底层的源码实现者，所以只能学习思路，至于平日代码实现，如果有机会实现，那确实厉害。</p>
<h3 id="什么是Vue响应式"><a href="#什么是Vue响应式" class="headerlink" title="什么是Vue响应式"></a>什么是Vue响应式</h3><blockquote>
<p>数据发生变化后，会重新对页面渲染，这就是Vue响应式</p>
</blockquote>
<p><img src="https://s2.loli.net/2024/05/31/2XGWTOD3uYEtJ6m.png" alt="image-20240531232228283"></p>
<h3 id="想完成这个过程，我们需要做些什么"><a href="#想完成这个过程，我们需要做些什么" class="headerlink" title="想完成这个过程，我们需要做些什么"></a>想完成这个过程，我们需要做些什么</h3><ul>
<li>侦测数据的变化</li>
<li>收集视图依赖了哪些数据</li>
<li>数据变化时，自动“通知”需要更新的视图部分，并进行更新</li>
</ul>
<p><strong>「它们对应专业俗语分别是：」</strong></p>
<ul>
<li>数据劫持 &#x2F; 数据代理</li>
<li>依赖收集</li>
<li>发布订阅模式</li>
</ul>
<h3 id="什么是发布订阅模式"><a href="#什么是发布订阅模式" class="headerlink" title="什么是发布订阅模式"></a>什么是发布订阅模式</h3><ul>
<li><strong>观察者模式</strong>是由具体目标调度，比如当事件触发，Dep 就会去调用观察者的方法，所以观察者模式的订阅者与发布者之间是存在依赖的</li>
<li><strong>发布&#x2F;订阅模式</strong>由统一调度中心调用，因此发布者和订阅者不需要知道对方的存在。</li>
</ul>
<p><img src="https://s2.loli.net/2024/05/31/NsmjRFWEiDtSqwZ.png" alt="image-20240531232458202"></p>
<p>vue响应式采用的就是发布订阅模式，举个生活中的例子说明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">比如小红最近在淘宝网上看上一双鞋子，但是联系到卖家后，才发现这双鞋卖光了。</span><br><span class="line">但是小红对这双鞋又非常喜欢，所以联系卖家，问卖家什么时候有货。</span><br><span class="line">卖家告诉她，要等一个星期后才有货，卖家告诉小红，要是你喜欢的话，你可以收藏我们的店铺，等有货的时候再通知你。</span><br><span class="line">所以小红收藏了此店铺。</span><br><span class="line">但与此同时，小明，小花等也喜欢这双鞋，也收藏了该店铺，等来货的时候就依次会通知他们;</span><br></pre></td></tr></table></figure>

<p>如何实现发布–订阅模式?</p>
<ol>
<li>首先要想好谁是发布者(比如上面的卖家)。</li>
<li>然后给发布者添加一个缓存列表，用于存放回调函数来通知订阅者(比如上面的买家收藏了卖家的店铺,卖家通过收藏了该店铺的一个列表名单)。</li>
<li>最后就是发布消息，发布者遍历这个缓存列表，依次触发里面存放的订阅者回调函数</li>
</ol>
<h3 id="如何侦测数据的变化"><a href="#如何侦测数据的变化" class="headerlink" title="如何侦测数据的变化"></a>如何侦测数据的变化</h3><p>有两种办法可以侦测到变化：<br> 使用<code>Object.defineProperty</code>和ES6的<code>Proxy</code>，这就是进行数据劫持或数据代理。</p>
<h4 id="Object-defineProperty实现"><a href="#Object-defineProperty实现" class="headerlink" title="Object.defineProperty实现"></a><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty">Object.defineProperty</a>实现</h4><p>Vue通过设定对象属性的 <code>setter/getter</code> 方法来监听数据的变化，通过<code>getter</code>进行依赖收集，而每个<code>setter</code>方法就是一个<code>观察者</code>，在<code>数据变更</code>的时候通知<code>订阅者</code>更新视图。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> () &#123;</span><br><span class="line">  <span class="comment">// set的时候会走这里，重新渲染</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;模拟视图渲染&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> data = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;浪里行舟&#x27;</span>,</span><br><span class="line">  <span class="attr">location</span>: &#123; <span class="attr">x</span>: <span class="number">100</span>, <span class="attr">y</span>: <span class="number">100</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 请看下一节</span></span><br><span class="line"><span class="title function_">observe</span>(data)</span><br></pre></td></tr></table></figure>

<p>定义核心函数observe</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">observe</span> (obj) &#123; <span class="comment">// 我们来用它使对象变成可观察的</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">      判断类型,obj可能是vue中的data对象，也可以是data中的某个属性值,</span></span><br><span class="line"><span class="comment">      例如:data:&#123; name: &#x27;浪里行舟&#x27;, location:&#123;  x: 100, y: 100 &#125; &#125;，这里的值可能是整个data，</span></span><br><span class="line"><span class="comment">      也可能是location的值，当location值也是对象的时候就需要再次监听location值对象。</span></span><br><span class="line"><span class="comment">      而属性name和location在监听data的时候就会监听这2个属性。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!obj || <span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(obj, key, obj[key])</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//监听对象的每个属性</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">defineReactive</span> (obj, key, value) &#123;</span><br><span class="line">    <span class="comment">// 递归子属性</span></span><br><span class="line">    <span class="title function_">observe</span>(value)</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="comment">//可枚举（可以遍历）</span></span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">true</span>, <span class="comment">//可配置（比如可以删除）</span></span><br><span class="line">      <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span> () &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;get&#x27;</span>, value) <span class="comment">// 监听</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">reactiveSetter</span> (newVal) &#123;</span><br><span class="line">        <span class="title function_">observe</span>(newVal) <span class="comment">//如果赋值是一个对象，也要递归子属性</span></span><br><span class="line">        <span class="comment">//如果有新值</span></span><br><span class="line">        <span class="keyword">if</span> (newVal !== value) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;set&#x27;</span>, newVal) <span class="comment">// 监听</span></span><br><span class="line">          <span class="title function_">render</span>() <span class="comment">//执行渲染逻辑</span></span><br><span class="line">          value = newVal</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改变data的属性，会触发set；然后获取data的属性，会触发get</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data.<span class="property">location</span> = &#123;</span><br><span class="line">  <span class="attr">x</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">y</span>: <span class="number">1000</span></span><br><span class="line">&#125;         <span class="comment">//打印=》     set &#123;x: 1000,y: 1000&#125; 染</span></span><br><span class="line">data.<span class="property">name</span> <span class="comment">//打印=》   get 浪里行舟</span></span><br></pre></td></tr></table></figure>

<p><strong>上面这段代码的主要作用</strong></p>
<p>observe这个函数传入一个 <code>obj（需要被追踪变化的对象）</code>，通过遍历所有属性的方式对该对象的每一个属性都通过 <code>defineReactive</code> 处理,给每个属性加上<code>set</code>和<code>get</code>方法,以此来达到实现侦测对象变化。</p>
<p>值得注意的是，observe 会进行递归调用，因此我们需要设置一个递归出口。</p>
<p><strong>那我们如何侦测Vue中data 中的数据，其实也很简单</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> &#123;</span><br><span class="line">    <span class="comment">/* Vue构造类 */</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_data</span> = options.<span class="property">data</span>;</span><br><span class="line">        <span class="title function_">observer</span>(<span class="variable language_">this</span>.<span class="property">_data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们只要 new 一个 Vue 对象，就会将 data 中的数据进行追踪变化。</p>
<p><strong>但是我们发现一个问题，上面的代码无法检测到对象属性的<code>添加或删除</code>(如data.location.a&#x3D;1,增加一个a属性)。</strong></p>
<p> 这是因为 Vue 通过Object.defineProperty来将对象的key转换成getter&#x2F;setter的形式来追踪变化，但getter&#x2F;setter只能追踪一个数据<code>是否被修改</code>，无法追踪<code>新增属性和删除</code>属性。</p>
<p>如果是删除属性，我们可以用<code>vm.$delete</code>实现，那如果是新增属性，该怎么办呢？</p>
<ol>
<li>可以使用 Vue.set(location, a, 1) 方法向嵌套对象添加响应式属性;</li>
<li>也可以给这个对象重新赋值，比如data.location &#x3D; {…data.location,a:1}</li>
</ol>
<p>Object.defineProperty 不能监听数组的变化，需要进行数组方法的重写</p>
<h3 id="观察者-Watcher"><a href="#观察者-Watcher" class="headerlink" title="观察者 Watcher"></a>观察者 Watcher</h3><h4 id="为什么引入Watcher"><a href="#为什么引入Watcher" class="headerlink" title="为什么引入Watcher"></a>为什么引入Watcher</h4><p>Vue 中定义一个 Watcher 类来表示<code>观察订阅依赖</code>。</p>
<p>至于为啥引入Watcher，《深入浅出vue.js》给出了很好的解释。</p>
<p>当<code>属性</code>发生变化后，我们要通知<code>用到数据</code>的地方，而使用这个数据的地方有很多，而且类型还不一样，既有可能是模板，也有可能是用户写的一个watch，这时需要抽象出一个<code>能集中处理</code>这些情况的类。</p>
<p>然后，我们在依赖收集阶段只收集这个封装好的类的实例进来，通知也只通知它一个，再由它负责通知其他地方。</p>
<p><strong>「依赖收集的目的」</strong> 将观察者 Watcher 对象存放到当前闭包中的订阅者 Dep 的 subs 中，形成如下所示的这样一个关系（图参考《剖析 Vue.js 内部运行机制》）。</p>
<p><img src="https://s2.loli.net/2024/06/02/7CrdP4YSnFBfkZs.png" alt="image-20240602230312707"></p>
<h4 id="Watcher的简单实现"><a href="#Watcher的简单实现" class="headerlink" title="Watcher的简单实现"></a>Watcher的简单实现</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">obj, key, cb</span>) &#123;</span><br><span class="line">    <span class="comment">// 将 Dep.target 指向自己</span></span><br><span class="line">    <span class="comment">// 然后触发属性的 getter 添加监听</span></span><br><span class="line">    <span class="comment">// 最后将 Dep.target 置空</span></span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cb</span> = cb</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">obj</span> = obj</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = key</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = obj[key]</span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 获得新值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">obj</span>[<span class="variable language_">this</span>.<span class="property">key</span>]</span><br><span class="line">   <span class="comment">// 我们定义一个 cb 函数，这个函数用来模拟视图更新，调用它即代表更新视图</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">cb</span>(<span class="variable language_">this</span>.<span class="property">value</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上就是 Watcher 的简单实现，在执行构造函数的时候将 Dep.target 指向自身，从而使得收集到了对应的 Watcher，在派发更新的时候取出对应的 Watcher ,然后执行 update 函数。</p>
<p><strong>「依赖的本质」</strong></p>
<p> 所谓的<code>依赖</code>，其实就是<code>Watcher</code>。</p>
<p> 至于如何收集依赖，总结起来就一句话:</p>
<p> 在<code>getter</code>中收集依赖（收集Watch当如Dep中），在<code>setter</code>中触发依赖。</p>
<p>先收集依赖，即把用到该数据的地方<code>收集起来</code>，然后等<code>属性发生变化</code>时，把之前收集好的依赖<code>循环触发</code>一遍就行了。</p>
<p>具体来说，当外界通过Watcher<code>读取数据</code>时，便会触发<code>getter</code>从而将<code>Watcher添加到依赖中</code>，哪个Watcher触发了getter，就把哪个Watcher收集到Dep中。</p>
<p>当数据发生变化时，会循环依赖列表，把所有的Watcher都通知一遍。</p>
<p>最后我们对 defineReactive 函数进行改造，在自定义函数中添加依赖收集和派发更新相关的代码,实现了一个简易的数据响应式:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">observe</span> (obj) &#123;</span><br><span class="line">  <span class="comment">// 判断类型</span></span><br><span class="line">  <span class="keyword">if</span> (!obj || <span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(obj, key, obj[key])</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">defineReactive</span> (obj, key, value) &#123;</span><br><span class="line">    <span class="title function_">observe</span>(value)  <span class="comment">// 递归子属性</span></span><br><span class="line">    <span class="keyword">let</span> dp = <span class="keyword">new</span> <span class="title class_">Dep</span>() <span class="comment">//新增</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="comment">//可枚举（可以遍历）</span></span><br><span class="line">      <span class="attr">configurable</span>: <span class="literal">true</span>, <span class="comment">//可配置（比如可以删除）</span></span><br><span class="line">      <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span> () &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;get&#x27;</span>, value) <span class="comment">// 监听</span></span><br><span class="line">     <span class="comment">// 将 Watcher 添加到订阅</span></span><br><span class="line">     <span class="comment">// target挂载发生在new Watch的时候</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">         <span class="comment">// 新增Watch到dep的subs中，就是说new了哪个Watch就要把哪个Watch收集进来</span></span><br><span class="line">         dp.<span class="title function_">addSub</span>(<span class="title class_">Dep</span>.<span class="property">target</span>) </span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">reactiveSetter</span> (newVal) &#123;</span><br><span class="line">        <span class="comment">// 如果赋值是一个对象，也要递归子属性</span></span><br><span class="line">        <span class="comment">// 例如上面的location是一个对象，那么这个对象是要继续observe的</span></span><br><span class="line">        <span class="title function_">observe</span>(newVal) </span><br><span class="line">        <span class="keyword">if</span> (newVal !== value) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;set&#x27;</span>, newVal) <span class="comment">// 监听</span></span><br><span class="line">          <span class="title function_">render</span>()</span><br><span class="line">          value = newVal</span><br><span class="line">         <span class="comment">// 执行 watcher 的 update 方法</span></span><br><span class="line">          dp.<span class="title function_">notify</span>() <span class="comment">//新增</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_data</span> = options.<span class="property">data</span>;</span><br><span class="line">        <span class="title function_">observer</span>(<span class="variable language_">this</span>.<span class="property">_data</span>);</span><br><span class="line">        <span class="comment">/* 新建一个Watcher观察者对象，这时候Dep.target会指向这个Watcher对象 */</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Watcher</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;模拟视图渲染&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 render function 被渲染的时候,<code>读取</code>所需对象的值，会触发 <code>reactiveGetter</code> 函数把当前的 Watcher 对象（存放在 Dep.target 中）收集到 Dep 类中去。</p>
<p>之后如果<code>修改</code>对象的值，则会触发 <code>reactiveSetter</code> 方法，通知 Dep 类调用 <code>notify</code> 来触发所有 Watcher 对象的 <code>update</code> 方法更新对应视图。</p>
<p><strong>「完整流程图」</strong></p>
<p><img src="https://s2.loli.net/2024/06/02/iz95c1fnKS3FlqQ.png" alt="image-20240602230619901"></p>
<ul>
<li>在 new Vue() 后， Vue 会调用_init 函数进行初始化，也就是init 过程，在 这个过程Data通过Observer转换成了getter&#x2F;setter的形式，来对数据追踪变化，当被设置的对象被读取的时候会执行getter 函数，而在当被赋值的时候会执行 setter函数。</li>
<li>当外界通过Watcher读取数据时，会触发getter从而将Watcher添加到依赖中。</li>
<li>在修改对象的值的时候，会触发对应的setter， setter通知之前依赖收集得到的 Dep 中的每一个 Watcher，告诉它们自己的值改变了，需要重新渲染视图。这时候这些 Watcher就会开始调用 update 来更新视图。</li>
</ul>
<h3 id="收集依赖"><a href="#收集依赖" class="headerlink" title="收集依赖"></a>收集依赖</h3><h4 id="为什么要收集依赖"><a href="#为什么要收集依赖" class="headerlink" title="为什么要收集依赖"></a>为什么要收集依赖</h4><blockquote>
<p>我们之所以要观察数据，其目的在于当数据的属性发生变化时，可以通知那些曾经使用了该数据的地方。比如例子中，模板中使用了location 数据，当它发生变化时，要向使用了它的地方发送通知。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> globalData = &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;浪里行舟&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> test1 = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">    <span class="attr">template</span>:</span><br><span class="line">        <span class="string">`&lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;span&gt;&#123;&#123;text&#125;&#125;&lt;/span&gt; </span></span><br><span class="line"><span class="string">        &lt;div&gt;`</span>,</span><br><span class="line">    <span class="attr">data</span>: globalData</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">let</span> test2 = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">    <span class="attr">template</span>:</span><br><span class="line">        <span class="string">`&lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;span&gt;&#123;&#123;text&#125;&#125;&lt;/span&gt; </span></span><br><span class="line"><span class="string">        &lt;div&gt;`</span>,</span><br><span class="line">    <span class="attr">data</span>: globalData</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果我们执行下面这条语句：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">globalData.text</span> = <span class="string">&#x27;前端工匠&#x27;</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>此时我们需要通知 <code>test1</code> 以及 <code>test2</code> 这两个Vue实例进行视图的<code>更新</code>,我们只有通过<code>收集依赖</code>才能知道哪些地方依赖我的数据，以及数据更新时<code>派发更新</code>。那依赖收集是如何实现的？其中的核心思想就是“事件发布订阅模式”。接下来我们先介绍两个重要角色– <code>订阅者 Dep</code>和<code>观察者 Watcher</code> ，然后阐述收集依赖的如何实现的。</p>
<h3 id="Dep-Watcher的关系"><a href="#Dep-Watcher的关系" class="headerlink" title="Dep,Watcher的关系"></a>Dep,Watcher的关系</h3><p>Observer负责将数据转换成getter&#x2F;setter形式； Dep负责管理数据的依赖列表；是一个发布订阅模式，上游对接Observer，下游对接Watcher Watcher是实际上的数据依赖，负责将数据的变化转发到外界(渲染、回调)； 首先将data传入Observer转成getter&#x2F;setter形式；当Watcher实例读取数据时，会触发getter，被收集到Dep仓库中；当数据更新时，触发setter，通知Dep仓库中的所有Watcher实例更新，Watcher实例负责通知外界</p>
<ul>
<li>Dep 负责收集所有相关的的订阅者 Watcher ，具体谁不用管，具体有多少也不用管，只需要根据 target 指向的计算去收集订阅其消息的 Watcher 即可，然后做好消息发布 notify 即可。</li>
<li>Watcher 负责订阅 Dep ，并在订阅的时候让 Dep 进行收集，接收到 Dep 发布的消息时，做好其 update 操作即可。</li>
</ul>
<p>Vue的操作就是加入了<strong>发布订阅</strong>模式，结合<code>Object.defineProperty</code>的劫持能力，实现了可用性很高的双向绑定。</p>
<h3 id="订阅器-Dep"><a href="#订阅器-Dep" class="headerlink" title="订阅器 Dep"></a>订阅器 Dep</h3><p><img src="https://s2.loli.net/2024/06/06/mPr6veQfq2WDKSL.png" alt="image-20240606000301782"></p>
<p><strong>「为什么引入 Dep」</strong><br> 收集依赖需要为依赖找一个存储依赖的地方，为此我们创建了Dep,它用来<code>收集依赖</code>、<code>删除依赖</code>和<code>向依赖发送</code>消息等。<br> 于是我们先来实现一个<code>订阅者 Dep 类</code>，用于<code>解耦属性</code>的依赖收集和派发更新操作，<strong>「说得具体点」</strong>:它的主要作用是用来<code>存放 Watcher 观察者</code>对象。我们可以把Watcher理解成一个<code>中介</code>的角色，<code>数据发生变化</code>时通知它，然后它再通知<code>其他地方</code>。</p>
<p><strong>「Dep的简单实现」</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span> () &#123;</span><br><span class="line">        <span class="comment">/* 用来存放Watcher对象的数组 */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 在subs中添加一个Watcher对象 */</span></span><br><span class="line">    addSub (sub) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(sub);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 通知所有Watcher对象更新视图 */</span></span><br><span class="line">    notify () &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">sub</span>) =&gt;</span> &#123;</span><br><span class="line">            sub.<span class="title function_">update</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码主要做两件事情：</p>
<ul>
<li>用 addSub 方法可以在目前的 <code>Dep</code> 对象中增加一个 <code>Watcher</code> 的订阅操作；</li>
<li>用 notify 方法通知目前 <code>Dep</code> 对象的 <code>subs</code> 中的所有 <code>Watcher</code> 对象触发更新操作。 所以当需要<code>依赖收集</code>的时候调用 addSub，当需要<code>派发更新</code>的时候调用 notify。</li>
</ul>
<p>也就说，所有的Watch最终会存放到Dep的subs中，并且视图更新的流程是，Dep触发了subs中的每个Watch，执行了Watch更新逻辑，Dep的操作是绕不过Watch的，这就验证了上面说的，Watch是一个中介的角色。</p>
<p>调用也很简单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dp = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line">dp.<span class="title function_">addSub</span>(<span class="function">() =&gt;</span> &#123;<span class="comment">//依赖收集的时候</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;emit here&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">dp.<span class="title function_">notify</span>()<span class="comment">//派发更新的时候</span></span><br></pre></td></tr></table></figure>

<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="先实现new-Vue的数据劫持"><a href="#先实现new-Vue的数据劫持" class="headerlink" title="先实现new Vue的数据劫持"></a>先实现new Vue的数据劫持</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//遍历data，进行数据劫持</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Observer</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(data).<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(data, item, data[item])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defineReactive</span>(<span class="params">data, key, val</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="variable language_">this</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, key, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal === val) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      val = newVal</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; <span class="keyword">typeof</span> options.<span class="property">data</span> == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">//模拟vue源码，挂载data到Vue的_data上</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_data</span> = options.<span class="property">data</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 劫持传入的data项</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Observer</span>(<span class="variable language_">this</span>.<span class="property">_data</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vue = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">text</span>: <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(vue)<span class="comment">//data中属性已经被劫持了</span></span><br></pre></td></tr></table></figure>

<h4 id="劫持以后-vue-mount-关联Watch"><a href="#劫持以后-vue-mount-关联Watch" class="headerlink" title="劫持以后,vue.mount()关联Watch"></a>劫持以后,vue.mount()关联Watch</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">js复制代码<span class="comment">//遍历data，进行数据拦截</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Observer</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(data).<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(data, item, data[item])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defineReactive</span>(<span class="params">data, key, val</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="variable language_">this</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, key, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 设置当前描述属性可被修改</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal === val) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      val = newVal</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">  <span class="comment">//----------4</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">vm, fn</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vm</span> = vm <span class="comment">//----------5</span></span><br><span class="line">    <span class="title function_">fn</span>() <span class="comment">//----------6</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Vue</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; <span class="keyword">typeof</span> options.<span class="property">data</span> == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_data</span> = options.<span class="property">data</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Observer</span>(<span class="variable language_">this</span>.<span class="property">_data</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  mount = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//--------------2</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Watcher</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">render</span>) <span class="comment">//--------------3</span></span><br><span class="line">  &#125;</span><br><span class="line">  render = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 省略一系列的渲染逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_data</span>.<span class="property">text</span> <span class="comment">//---------7</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> vue = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">text</span>: <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">vue.<span class="title function_">mount</span>() <span class="comment">//------------ 1</span></span><br></pre></td></tr></table></figure>

<p>Vue mount函数的功能是去<code>读取data中的属性</code>，<code>渲染</code>到页面上。</p>
<p>这里的关键一步是<code>读数据</code>。</p>
<p>那么，读数据最终是要进入数据劫持get方法的。这时我们可以创建一个Watch（观察者）作为中介，让它去进入get。</p>
<p>而mount起到的作用是渲染，自然，在构造Watch的时候需要传入渲染函数。</p>
<p>回到前面我们说的，Watch充当的是中介角色，那么，它是谁和谁之前的中介？实际上它是Observer和我们后面要讲的Dep的中介。</p>
<p>既然是中介，那么它就需要拿到双方的数据。又因为Observer需要观察data，所以这里我们需要将整个Vue构造函数挂载到Watch自身。</p>
<p><strong>整理下流程：</strong></p>
<p>执行<code>vue.mount()</code>渲染页面，需要在Vue定义渲染函数render，然后在mount通过中介Watch去执行定义在Vue的render函数。</p>
<p>创建中介Watch，执行传入的渲染函数，渲染肯定是需要根据页面绑定了哪些data属性去读取data的，这个时候就会触发get方法,</p>
<p>进入get拿到对应的值。</p>
<h4 id="添加dep后大概结构"><a href="#添加dep后大概结构" class="headerlink" title="添加dep后大概结构"></a>添加dep后大概结构</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//defineReactive是对Observer的抽离</span></span><br><span class="line">  <span class="keyword">const</span> defineReactive = <span class="keyword">function</span>(<span class="params">obj, key</span>) &#123;</span><br><span class="line">    <span class="comment">// 以下代码省略</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Vue</span> = <span class="keyword">function</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Vue&quot;</span>,<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">//打印1  Vue &#123;</span></span><br><span class="line">                  <span class="attr">_data</span>:&#123;</span><br><span class="line">                      <span class="attr">text</span>: <span class="string">&quot;123&quot;</span></span><br><span class="line">                      get <span class="attr">text</span>: ƒ <span class="title function_">get</span>()</span><br><span class="line">                      set <span class="attr">text</span>: ƒ <span class="title function_">set</span>(newVal)</span><br><span class="line">                    &#125;,</span><br><span class="line">                  <span class="attr">mount</span>: ƒ (),</span><br><span class="line">                  <span class="attr">render</span>: ƒ ()</span><br><span class="line">                &#125;</span><br><span class="line">    <span class="comment">// 以下代码省略</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Watcher</span> = <span class="keyword">function</span>(<span class="params">vm, fn</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Watcher&quot;</span>,<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">//打印3 Watcher  this是下面的Dep中subs的对象</span></span><br><span class="line">    <span class="comment">// 以下代码省略</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Dep</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Dep&quot;</span>,<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">//打印2  Dep   &#123; </span></span><br><span class="line">                    <span class="attr">target</span>: <span class="literal">null</span>,</span><br><span class="line">                    <span class="attr">subs</span>: [</span><br><span class="line">                      &#123;        <span class="comment">//是一个Watcher实例</span></span><br><span class="line">                        <span class="attr">subs</span>: <span class="title class_">Array</span>(<span class="number">1</span>)</span><br><span class="line">                        <span class="number">0</span>: <span class="title class_">Watcher</span></span><br><span class="line">                        <span class="attr">vm</span>: &#123;    <span class="comment">//是一个Vue实例</span></span><br><span class="line">                            <span class="attr">_data</span>:&#123;</span><br><span class="line">                              <span class="attr">text</span>: <span class="string">&quot;123&quot;</span>,<span class="comment">//该属性有了get和set方法</span></span><br><span class="line">                              get <span class="attr">text</span>: ƒ <span class="title function_">get</span>(),</span><br><span class="line">                              set <span class="attr">text</span>: ƒ <span class="title function_">set</span>(newVal)</span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">mount</span>: ƒ (),</span><br><span class="line">                            <span class="attr">render</span>: ƒ ()</span><br><span class="line">                          &#125;,</span><br><span class="line"></span><br><span class="line">                        <span class="attr">addDep</span>: ƒ (dep),</span><br><span class="line">                        <span class="attr">update</span>: ƒ (),</span><br><span class="line">                        <span class="attr">value</span>: <span class="literal">undefined</span></span><br><span class="line">                      &#125;</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">depend</span>: ƒ (),</span><br><span class="line">                    <span class="attr">addSub</span>: ƒ (watcher),</span><br><span class="line">                    <span class="attr">notify</span>: ƒ ()</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以下代码省略</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> vue = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">text</span>: <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  vue.<span class="title function_">mount</span>(); </span><br><span class="line">  vue.<span class="property">_data</span>.<span class="property">text</span> = <span class="string">&#x27;123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="详细代码"><a href="#详细代码" class="headerlink" title="详细代码"></a>详细代码</h4><p>参考这个图，会了看的更清晰，注意看执行顺序，在new Vue的时候，就会按顺序，初始化各个构造函数</p>
<p><img src="https://s2.loli.net/2024/06/06/WITrDNomRdKs1qH.png" alt="image-20240606000442133"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 作用：</span></span><br><span class="line"><span class="comment"> * 劫持data的各个属性，挂载set和get方法</span></span><br><span class="line"><span class="comment"> * 在get中将Watch添加到dep的subs中</span></span><br><span class="line"><span class="comment"> * 在set中触发dep.notify更新视图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Observer</span> = <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)   <span class="comment">//开始4 new Vue的时候就会执行</span></span><br><span class="line">    <span class="comment">// 循环修改为每个属性添加get set</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> data) &#123;</span><br><span class="line">        <span class="title function_">defineReactive</span>(data, key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defineReactive = <span class="keyword">function</span> (<span class="params">obj, key</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)    <span class="comment">//开始5 new Vue的时候就会执行</span></span><br><span class="line">    <span class="comment">// 局部变量dep，用于get set内部调用</span></span><br><span class="line">    <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>();</span><br><span class="line">    <span class="comment">// 获取当前值</span></span><br><span class="line">    <span class="keyword">let</span> val = obj[key];</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">        <span class="comment">// 设置当前描述属性为可被循环</span></span><br><span class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 设置当前描述属性可被修改</span></span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>)<span class="comment">//开始10  开始19</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;in get&#x27;</span>);</span><br><span class="line">            <span class="comment">// 调用依赖收集器中的addSub，用于收集当前属性与Watcher中的依赖关系</span></span><br><span class="line">            dep.<span class="title function_">depend</span>();</span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">set</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>)<span class="comment">//开始15</span></span><br><span class="line">            <span class="keyword">if</span> (newVal === val) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            val = newVal;</span><br><span class="line">            <span class="comment">// 当值发生变更时，通知依赖收集器，更新每个需要更新的Watcher，</span></span><br><span class="line">            <span class="comment">// 这里每个需要更新通过什么断定？dep.subs</span></span><br><span class="line">            dep.<span class="title function_">notify</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Vue</span> = <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">6</span>)<span class="comment">//开始1 new Vue的时候就会执行</span></span><br><span class="line">    <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 将data赋值给this._data，源码这部分用的Proxy，这里我们用最简单的方式临时实现</span></span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; <span class="keyword">typeof</span> options.<span class="property">data</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">7</span>)<span class="comment">//开始2  options.data是个函数，它返回了一个对象</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_data</span> = options.<span class="property">data</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 挂载Dom函数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mount</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">8</span>)  <span class="comment">//开始7  new Vue以后，执行vue.mount()</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Watcher</span>(self, self.<span class="property">render</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 渲染函数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">render</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">9</span>) <span class="comment">//开始9 开始18  render函数执行后走到这里</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="property">_data</span>.<span class="property">text</span>;  <span class="comment">//这里取data值的时候，就会走get方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 开始3， 监听this._data</span></span><br><span class="line">    <span class="comment">//new Vue的时候就会执行,这里执行完，就表示new Vue的过程执行完了</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Observer</span>(<span class="variable language_">this</span>.<span class="property">_data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Watcher</span> = <span class="keyword">function</span> (<span class="params">vm, fn</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">10</span>)  <span class="comment">//开始8  执行vue.mount()以后会走到这里</span></span><br><span class="line">    <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vm</span> = vm;</span><br><span class="line">    <span class="comment">// 将当前Dep.target指向自己</span></span><br><span class="line">    <span class="comment">// 每次执行new Watch的时候，都会把当前的Watcher挂载到Dep.target</span></span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 向Dep方法添加当前Wathcer</span></span><br><span class="line">    <span class="comment">// this.addDep = function (dep) &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(11) //开始13  </span></span><br><span class="line">    <span class="comment">//     dep.addSub(self);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// 更新方法，用于触发vm._render</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">update</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">12</span>)<span class="comment">//开始17</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;in watcher update&#x27;</span>);</span><br><span class="line">        <span class="title function_">fn</span>(); <span class="comment">//Vue中的render函数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里会首次调用vm._render，从而触发text的get</span></span><br><span class="line">    <span class="comment">// 从而将当前的Wathcer与Dep关联起来</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="title function_">fn</span>();   <span class="comment">//开始9  fn是Vue中的render函数，这里fn()在赋值的时候会执行</span></span><br><span class="line">    <span class="comment">// 这里清空了Dep.target，为了防止notify触发时，不停的绑定Watcher与Dep，</span></span><br><span class="line">    <span class="comment">// 造成代码死循环</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Watcher&#x27;</span>, <span class="variable language_">this</span>)</span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Dep</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//开始6  new Vue》Observer》defineReactive》new Dep()</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">13</span>)</span><br><span class="line">    <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 收集目标，先把它置空</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 存储收集器中需要通知的Watcher</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span> = [];</span><br><span class="line">    <span class="comment">// 当有目标时，绑定Dep与Wathcer的关系</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">depend</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">14</span>)  <span class="comment">//开始11   开始20 走了get获取属性后，就要进行依赖收集 </span></span><br><span class="line">        <span class="comment">// targrt挂载发生在new Watch的时候</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">15</span>)<span class="comment">//开始12  </span></span><br><span class="line">            self.<span class="title function_">addSub</span>(<span class="title class_">Dep</span>.<span class="property">target</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 为当前收集器添加Watcher</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">addSub</span> = <span class="keyword">function</span> (<span class="params">watcher</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">16</span>)<span class="comment">//开始14</span></span><br><span class="line">        self.<span class="property">subs</span>.<span class="title function_">push</span>(watcher);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通知收集器中所的所有Wathcer，调用其update方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">notify</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">17</span>) <span class="comment">//开始16</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; self.<span class="property">subs</span>.<span class="property">length</span>; i += <span class="number">1</span>) &#123;</span><br><span class="line">            self.<span class="property">subs</span>[i].<span class="title function_">update</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vue = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">text</span>: <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">vue.<span class="title function_">mount</span>(); <span class="comment">// 挂载dom，渲染页面</span></span><br><span class="line">vue.<span class="property">_data</span>.<span class="property">text</span> = <span class="string">&#x27;123&#x27;</span>; <span class="comment">// 修改属性值，触发set</span></span><br></pre></td></tr></table></figure>

<p><strong>「解析：」</strong></p>
<ul>
<li>一开始new Vue ，会走到46行执行Vue构造函数，打印6，然后判断传入的是否是个函数，从new Vue可以看出，传入的是个data()函数，然后将函数执行后返回的整个data对象挂载到vue的<code>_data</code>属性上（真实的vue也是这么操作的）</li>
<li>接着依次挂载<code>mount</code>和<code>render</code>函数。</li>
<li>然后 new Observer(this._data);</li>
<li>new Observer 的时候会走到第一行<code>Observer(关键函数)</code>，打印1。我们发现Observer实际就是给data数据都添加<code>上get和set</code>方法，只不过不添加的方法defineReactive给抽离出去了。</li>
<li>然后走到第9行，执行defineReactive，打印2。 defineReactive的作用：<ul>
<li>劫持<code>data</code>的各个属性，挂载<code>set</code>和<code>get</code>方法</li>
<li>在<code>get</code>中将<code>Watch</code>添加到<code>dep</code>的<code>subs</code>中</li>
<li>在<code>set</code>中触发<code>dep.notify</code>更新视图</li>
</ul>
</li>
<li>然后走到12行，new Dep的时候，会走到95行执行Dep，打印13。每次new Dep 的时候，都会<strong>置空target，this.target &#x3D; null</strong>，Dep函数剩下的代码都只是定义函数depend和addSub，notify，都不会执行，会跳出Dep函数。然后会到defineReactive函数第13行。</li>
<li>然后15行给每个<code>属性</code>加上<code>get和set</code>方法。注意：此时只是在挂载，还没有执行，因此不会进入get，set方法内部。也就是说defineReactive剩下的代码中的函数也不会执行，所以会回到Observer，再回到67行new Observer，即<strong>new Vue的过程走完了</strong>。</li>
</ul>
<h3 id="new-Vue执行完毕"><a href="#new-Vue执行完毕" class="headerlink" title="new Vue执行完毕"></a>new Vue执行完毕</h3><h4 id="开始执行vue-mount"><a href="#开始执行vue-mount" class="headerlink" title="开始执行vue.mount()"></a><strong>开始执行vue.mount()</strong></h4><ul>
<li>然后走到135行的vue.mount()，走到56行，打印8。执行new Watcher，进入Watcher构造函数打印10，然后<code>this.vm = vm; </code>，将vue实例挂载到Watch的vm属性上了。<strong>Dep.target &#x3D; this</strong>，将watch实例挂载到了Dep的target属性上，从而关联起来。然后挂载addDep和update方法，只是定义，没有执行。</li>
<li>接着89行this.value &#x3D; fn()：fn实际是传进来的<code>render</code>函数（Vue&#x3D;&gt;new Watcher(self, self.render)&#x3D;&gt;vm, fn），由于后面有()，所以会立即执行。然后走到60行的render函数，打印9，返回 <code>self._data.text</code>,然后回到Watch中<code>this.value</code>就是返回值data.text。然后，关键的来了：<code>self._data.text</code>这里读取了data中的text,那么，这一步就会触发<code>get</code>方法。</li>
<li>然后走到21行的get，打印3。</li>
<li>然后走到25行，执行dep.depend()，再走到104行，打印14。</li>
<li>这时候判断<code>Dep.target</code>，由于第8步将<code>watch</code>挂载到了<strong>Dep.target</strong>，这时候为true，所以打印15。然后执行<code>Dep.target.addDep(self)</code>，其实就是执行<code>Watch.addDep(self)</code>，然后执行<code>self.addSub(Dep.target)</code>。</li>
<li>然后进入<code>this.addSub</code>打印16，完成了依赖收集，<strong>subs中就有了Watch了</strong>。然后会回到get，执行最后一行，退出get，接着回到this.render，退出render函数，接着回到Watch中的<code>this.value = fn()</code>，继续往后走，<strong>Dep.target &#x3D; null</strong>，避免陷入死循环，然后Watch执行完了。</li>
</ul>
<h4 id="vue-mount-也执行完毕"><a href="#vue-mount-也执行完毕" class="headerlink" title="vue.mount()也执行完毕"></a>vue.mount()也执行完毕</h4><p><strong>开始执行修改操作</strong></p>
<ul>
<li>136行赋值操作了<code>vue._data.text = &#39;123&#39;</code>，这时候会走到28行的set，打印4，然后<code>设置值为新值</code>。</li>
<li>继续向下走，到36行，<code>dep.notify()</code>，然后走到119行，打印17。</li>
<li>会走到122行，<code>遍历Dep</code>中<code>subs</code>数组里面所有的<code>Watch</code>，触发Watch的<code>update</code>方法，走到82行，打印12。</li>
<li>执行<code>Watcher</code>中的<code>fn()</code>，即<code>Vue</code>中的<code>render</code>函数（new Watcher(self, self.render)时传入的render函数），走到60行，打印9。render函数中其实就可以做一些渲染的操作，例如：获取某个节点，将他的内容变成获取的值，就完成了页面的渲染。</li>
<li>走到63行，取data.text，会走get，走到21，打印3。</li>
<li>执行<code>dep.depend()</code>，走到Dep中的<code>this.depend</code>，打印14。但是由于<strong>Dep.target为null</strong>，15不会打印，也就是说到了这里，所有的流程执行完了。</li>
</ul>
<h4 id="全部执行完毕"><a href="#全部执行完毕" class="headerlink" title="全部执行完毕"></a>全部执行完毕</h4><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>响应式原理，大龄前端确实应该掌握的必需品，如今我才看确实有点晚。</p>
<p>不过，学习任何时候都不算晚，只是当初看着晦涩难懂的代码如今看起来居然如鱼得水，也真是奇怪。</p>
<p>而且，这并非工程化的核心，如果涉及到基础开发才会需要了解，平时我个人是仅作为拓展知识了解的。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6850418111985352711">vue响应式详解（重学前端-vue篇1）</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6932659815424458760#heading-13">0年前端的Vue响应式原理学习总结1：基本原理 - 掘金 (juejin.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1G54y1s7xV/?spm_id_from=333.337.search-card.all.click">【尚硅谷】Vue源码解析之数据响应式原理</a></p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2024/05/29/2024%E5%B9%B4%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%BF%87%E6%B8%A1%E5%B7%A5%E4%BD%9C%E4%BD%93%E9%AA%8C/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2024-06-27 12:35:37
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/%E9%9D%A2%E8%AF%95/" title="面试">
                        #面试
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/vue3/" title="vue3">
                        #vue3
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2024/06/02/10%E5%88%86%E9%92%9F%E4%BA%86%E8%A7%A3%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFVue%E5%93%8D%E5%BA%94%E5%BC%8F"><span class="toc-text">什么是Vue响应式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%B3%E5%AE%8C%E6%88%90%E8%BF%99%E4%B8%AA%E8%BF%87%E7%A8%8B%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88"><span class="toc-text">想完成这个过程，我们需要做些什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">什么是发布订阅模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BE%A6%E6%B5%8B%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-text">如何侦测数据的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Object-defineProperty%E5%AE%9E%E7%8E%B0"><span class="toc-text">Object.defineProperty实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E8%80%85-Watcher"><span class="toc-text">观察者 Watcher</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BC%95%E5%85%A5Watcher"><span class="toc-text">为什么引入Watcher</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Watcher%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text">Watcher的简单实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E9%9B%86%E4%BE%9D%E8%B5%96"><span class="toc-text">收集依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%94%B6%E9%9B%86%E4%BE%9D%E8%B5%96"><span class="toc-text">为什么要收集依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dep-Watcher%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">Dep,Watcher的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E5%99%A8-Dep"><span class="toc-text">订阅器 Dep</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%88%E5%AE%9E%E7%8E%B0new-Vue%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81"><span class="toc-text">先实现new Vue的数据劫持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81%E4%BB%A5%E5%90%8E-vue-mount-%E5%85%B3%E8%81%94Watch"><span class="toc-text">劫持以后,vue.mount()关联Watch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0dep%E5%90%8E%E5%A4%A7%E6%A6%82%E7%BB%93%E6%9E%84"><span class="toc-text">添加dep后大概结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E4%BB%A3%E7%A0%81"><span class="toc-text">详细代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#new-Vue%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95"><span class="toc-text">new Vue执行完毕</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E6%89%A7%E8%A1%8Cvue-mount"><span class="toc-text">开始执行vue.mount()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vue-mount-%E4%B9%9F%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95"><span class="toc-text">vue.mount()也执行完毕</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E9%83%A8%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95"><span class="toc-text">全部执行完毕</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-text">结语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'pCBXervTb85ZiuK9XbcJpDaR-gzGzoHsz',
        appKey: '33EDuYO0RDrO2L7x2R6ZL5GQ',
        placeholder: '请输入您的评论,您的意见将会让文章更完美。',
        avatar: 'retro',
        lang: 'zh-cn'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/CrazyStudent13">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2024 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
    <div class="footer-views">
      
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        
      
          本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        
      
          本站访客数<span id="busuanzi_value_site_uv"></span>人
        
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="请搜索吧....">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E6%B5%85%E6%9E%90vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86 + '&url=' + https%3A%2F%2Fcrazystudent13.github.io%2F2024%2F05%2F31%2F%25E6%25B5%2585%25E6%259E%2590vue%25E7%259A%2584%25E5%2593%258D%25E5%25BA%2594%25E5%25BC%258F%25E5%258E%259F%25E7%2590%2586%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://crazystudent13.github.io/2024/05/31/%E6%B5%85%E6%9E%90vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
